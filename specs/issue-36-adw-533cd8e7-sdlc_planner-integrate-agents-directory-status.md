# Feature: Integrate Agents Directory Status for Enhanced Workflow Visibility

## Metadata
issue_number: `36`
adw_id: `533cd8e7`
issue_json: `{"number":36,"title":"this is how the agents directory looks like basica...","body":"this is how the agents directory looks like basically looks like. there is great micro level details that this can give. especially the jsonl format of certain agents will give live data. For now I want you to research and document your undrestanding. \n\nTry to implement something that  we can use this directory tree directly to get more updates and show the status of the ticket\n\nensure that the code does not break. \n\nYou may need to analyze the agents folder how it looks and waht it has and try to modify things in our adw system where necessary."}`

## Feature Description
This feature enhances the ADW workflow visibility by exposing detailed status information from the agents directory structure. Each ADW workflow execution creates a rich directory tree under `agents/{adw_id}/` containing subdirectories for each workflow stage (sdlc_planner, sdlc_implementor, tester, reviewer, documenter, ops, etc.). Each stage directory contains:
- `raw_output.jsonl` - Streaming logs with detailed progress information in JSONL format
- `raw_output.json` - Final result/summary data in JSON format
- `execution.log` - Standard execution logs
- `prompts/` - Directory containing prompt templates used
- Additional stage-specific artifacts (screenshots, generated files, etc.)

The agents directory provides granular, micro-level details about workflow execution that can be parsed and displayed to users, giving them real-time visibility into what each workflow stage is doing. This feature will create new API endpoints and enhance the UI to surface this rich data.

## User Story
As a developer using the AgenticKanban system
I want to see detailed real-time status information from the agents directory
So that I can monitor workflow progress at a granular level, understand what each stage is doing, debug issues more effectively, and have complete visibility into the AI-driven development process

## Problem Statement
Currently, the system has rich workflow execution data stored in the `agents/{adw_id}/` directory structure, including:
- JSONL streaming logs with detailed progress messages
- JSON result files with execution summaries
- Stage-specific execution logs
- Prompts used by each agent
- Screenshots and other artifacts

However, this valuable data is not fully exposed through the API or UI. Users cannot easily:
- View detailed stage-by-stage progress
- Access streaming logs from JSONL files
- See which specific prompts were executed
- Browse artifacts generated by each stage
- Monitor real-time execution status at a micro level

The existing `/api/stage-logs` endpoint provides some log access, but we need to enhance it and create additional endpoints to expose the full richness of the agents directory structure.

## Solution Statement
We will enhance the ADW system to fully leverage the agents directory structure by:

1. **Enhancing Backend APIs** - Extend existing `/api/stage-logs` endpoints to return more comprehensive data, and create new endpoints to:
   - List all available stages for an ADW ID
   - Access prompt files used by each stage
   - Retrieve execution logs
   - Browse stage-specific artifacts

2. **Creating Directory Browser API** - Build a new API endpoint that allows browsing the agents directory structure, returning file listings and metadata for each ADW workflow

3. **Enhancing Frontend Display** - Update the StageLogsViewer component to:
   - Display streaming JSONL logs with better formatting
   - Show final result JSON data prominently
   - Display execution logs inline
   - Provide access to prompts and artifacts
   - Add visual indicators for available vs. unavailable data

4. **Adding Real-time Monitoring** - Implement periodic polling or WebSocket updates to refresh stage logs as they're being written

This solution will provide users with complete visibility into the workflow execution, making the system more transparent and easier to debug.

## Relevant Files
Use these files to implement the feature:

- `server/api/adws.py` - Contains existing ADW metadata API endpoints, provides pattern for new endpoints
- `server/api/stage_logs.py` - Contains stage-specific logging endpoints that need enhancement
- `server/server.py` - FastAPI server that needs to register new routes
- `src/components/kanban/StageLogsViewer.jsx` - Frontend component for displaying logs, needs enhancement
- `src/components/kanban/WorkflowLogViewer.jsx` - Base log viewer component
- `src/components/kanban/StageProgressionViewer.jsx` - Stage progression UI that may need updates
- `src/stores/kanbanStore.js` - Frontend state management for fetching and storing log data
- `adws/adw_modules/state.py` - ADW state management that tracks agents directory paths
- `adws/README.md` - Documentation of ADW workflow structure and agents directory

### New Files
- `server/api/agents_directory.py` - New API endpoint for browsing agents directory structure
- `src/components/kanban/AgentsDirectoryBrowser.jsx` - New component for browsing agents directory
- `src/components/kanban/PromptViewer.jsx` - New component for displaying prompt files
- `specs/issue-36-adw-533cd8e7-sdlc_planner-integrate-agents-directory-status.md` - This specification file

## Implementation Plan

### Phase 1: Backend API Enhancement
Enhance the backend to expose more comprehensive data from the agents directory structure. This includes improving existing endpoints and creating new ones for directory browsing, prompt access, and artifact retrieval.

### Phase 2: Frontend Component Development
Create new React components and enhance existing ones to display the rich data from the agents directory. This includes building a directory browser, prompt viewer, and enhanced log display.

### Phase 3: Integration and Testing
Integrate the new components with the existing Kanban board, ensure proper data flow, add error handling, and validate that the system works correctly without breaking existing functionality.

## Step by Step Tasks
IMPORTANT: Execute every step in order, top to bottom.

### Research and Document Current Structure
- Analyze the agents directory structure for an existing ADW workflow
- Document the typical file/directory layout for each stage (sdlc_planner, sdlc_implementor, etc.)
- Identify all file types present (.jsonl, .json, .log, .md, images, etc.)
- Document the schema/format of JSONL streaming logs
- Document the schema/format of JSON result files
- Create a reference document showing example directory trees

### Enhance Backend API - Stage Logs Endpoint
- Update `server/api/stage_logs.py` to return additional metadata
- Add file existence indicators (has_jsonl_logs, has_json_result, has_execution_log)
- Add file paths to the response for client-side download/access
- Add stage directory contents listing
- Improve error handling and logging
- Add response model validation with Pydantic

### Create Backend API - Agents Directory Browser
- Create new file `server/api/agents_directory.py`
- Implement `GET /api/agents/{adw_id}/directory` endpoint to list directory structure
- Implement `GET /api/agents/{adw_id}/directory/{stage}` endpoint to list stage-specific files
- Implement `GET /api/agents/{adw_id}/file` endpoint with query param for file path
- Add proper error handling for missing files/directories
- Add MIME type detection for serving different file types
- Register the new router in `server/server.py`

### Create Backend API - Prompt Files Access
- Add endpoint `GET /api/agents/{adw_id}/{stage}/prompts` to list prompt files
- Add endpoint `GET /api/agents/{adw_id}/{stage}/prompts/{filename}` to retrieve prompt content
- Add proper error handling and validation
- Update API documentation

### Enhance Frontend State Management
- Update `src/stores/kanbanStore.js` to add actions for fetching agents directory data
- Add action `fetchAgentsDirectory(taskId, adwId)` to fetch directory structure
- Add action `fetchPromptFile(taskId, adwId, stage, filename)` to fetch prompt content
- Add action `fetchStageArtifacts(taskId, adwId, stage)` to list stage artifacts
- Add state fields for storing fetched data
- Add error handling and loading states

### Create Frontend Component - Agents Directory Browser
- Create new file `src/components/kanban/AgentsDirectoryBrowser.jsx`
- Build tree-view component to display directory structure
- Add file type icons for different file types (.jsonl, .json, .log, .md, images)
- Add click handlers to open/preview files
- Add loading and error states
- Style component to match existing UI patterns

### Create Frontend Component - Prompt Viewer
- Create new file `src/components/kanban/PromptViewer.jsx`
- Build modal/panel to display prompt file content
- Add syntax highlighting for markdown/text content
- Add copy-to-clipboard functionality
- Add close/minimize controls
- Style component to match existing modal patterns

### Enhance Frontend Component - Stage Logs Viewer
- Update `src/components/kanban/StageLogsViewer.jsx` to show enhanced data
- Add section to display execution.log content if available
- Add section to list and access prompt files used
- Add section to browse stage-specific artifacts
- Add visual indicators for available vs unavailable data
- Add refresh/reload functionality for each data type
- Improve error messaging and empty states

### Update Frontend Component - Workflow Log Viewer
- Enhance `src/components/kanban/WorkflowLogViewer.jsx` if needed
- Add better JSONL log parsing and display
- Add collapsible sections for verbose log entries
- Add filtering by log level (INFO, DEBUG, ERROR)
- Add search functionality within logs
- Improve timestamp formatting

### Add Real-time Updates
- Implement polling mechanism to refresh stage logs periodically
- Add WebSocket message handlers for stage progression updates
- Update UI automatically when new log data is available
- Add visual indicator when new data is available (pulse/badge)
- Add manual refresh button as fallback

### Integration with Kanban Board
- Update KanbanCard or task detail view to show enhanced status
- Add "View Detailed Logs" button that opens enhanced StageLogsViewer
- Add "Browse Agents Directory" button that opens AgentsDirectoryBrowser
- Ensure proper data flow from task -> ADW ID -> agents directory
- Test integration with existing workflow triggers

### Error Handling and Edge Cases
- Handle missing agents directory gracefully
- Handle partially completed workflows (some stages missing)
- Handle malformed JSONL/JSON files
- Handle file read errors (permissions, corruption)
- Add retry logic for failed API requests
- Add user-friendly error messages
- Log errors appropriately on backend

### Testing and Validation
- Test with multiple ADW IDs to ensure consistency
- Test with workflows at different stages of completion
- Test error scenarios (missing files, invalid data)
- Verify no performance degradation with large log files
- Test concurrent access to agents directory
- Verify no memory leaks in frontend components
- Run all validation commands

### Documentation
- Document new API endpoints in backend code comments
- Add JSDoc comments to new React components
- Update README or architecture docs if needed
- Add inline comments explaining complex logic
- Document the agents directory structure in a reference doc

### Final Validation
- Run all validation commands to ensure no regressions
- Verify existing functionality still works
- Test end-to-end workflow from creating task to viewing detailed logs
- Check console for errors or warnings
- Verify responsiveness on different screen sizes

## Testing Strategy

### Unit Tests
- Test API endpoints for agents directory browsing
- Test API endpoints for stage logs retrieval
- Test prompt file access endpoints
- Test error handling for missing files/directories
- Test JSONL and JSON parsing functions
- Test frontend store actions for data fetching
- Test React components render correctly with various data states

### Integration Tests
- Test complete flow from Kanban task -> ADW ID -> agents directory -> UI display
- Test WebSocket updates triggering log refreshes
- Test switching between different stages in StageLogsViewer
- Test opening and closing AgentsDirectoryBrowser
- Test accessing prompts from different stages

### Edge Cases
- ADW workflow with no agents directory yet (just started)
- ADW workflow with partial completion (some stages done, others pending)
- Malformed JSONL files (incomplete lines, invalid JSON)
- Very large log files (performance testing)
- Missing prompt files
- Corrupted JSON result files
- Simultaneous requests for same ADW ID from multiple users
- Network errors during log fetching
- Browser tab closed/reopened during workflow execution

## Acceptance Criteria
- Users can view detailed stage-by-stage logs from the agents directory
- Users can see JSONL streaming logs formatted correctly
- Users can view final JSON result data for each stage
- Users can browse the agents directory structure
- Users can view prompt files used by each agent
- Users can access execution logs for each stage
- UI provides clear visual indicators for available vs unavailable data
- Real-time updates reflect new log data as it becomes available
- Error states are handled gracefully with user-friendly messages
- All existing functionality continues to work without regression
- Performance is acceptable even with large log files
- API responses include proper error codes and messages
- New components follow existing UI/UX patterns

## Validation Commands
Execute every command to validate the feature works correctly with zero regressions.

- `cd server && uv run pytest` - Run server tests to validate the feature works with zero regressions
- `bun tsc --noEmit` - Run frontend tests to validate the feature works with zero regressions
- `bun run build` - Run frontend build to validate the feature works with zero regressions

## Notes

### Agents Directory Structure Reference
Based on analysis of existing ADW workflows, the typical structure is:
```
agents/{adw_id}/
├── adw_state.json                           # Workflow state
├── {stage_name}/                            # e.g., sdlc_planner, sdlc_implementor, etc.
│   ├── raw_output.jsonl                     # Streaming logs (JSONL format)
│   ├── raw_output.json                      # Final result (JSON format)
│   ├── execution.log                        # Execution logs
│   ├── prompts/                             # Prompt templates used
│   │   └── {prompt_name}.txt
│   └── {stage_specific_artifacts}/          # e.g., review_img/, plan.md
```

### JSONL Format
Each line in `raw_output.jsonl` is a JSON object with fields like:
- `timestamp`: ISO 8601 timestamp
- `level`: Log level (INFO, DEBUG, ERROR, etc.)
- `message`: Human-readable message
- `current_step`: Current workflow step
- `details`: Additional details
- Custom fields specific to the agent/stage

### JSON Result Format
The `raw_output.json` file typically contains:
- Summary of stage execution
- Key results/outputs
- Status indicators
- Metrics and timing information
- Custom fields specific to the agent/stage

### Performance Considerations
- Implement pagination for very large JSONL files
- Consider streaming large files instead of loading entirely into memory
- Add caching for frequently accessed logs
- Use lazy loading for directory browsing
- Implement virtualization for long log lists in UI

### Future Enhancements
- Add download functionality for logs and artifacts
- Add log filtering and advanced search
- Add comparison view for multiple ADW executions
- Add visualization of workflow execution timeline
- Add notifications when specific log patterns appear (errors, warnings)
- Add log aggregation across multiple ADW workflows
- Export logs in different formats (CSV, PDF)

### Security Considerations
- Validate ADW ID format to prevent directory traversal attacks
- Sanitize file paths before accessing filesystem
- Limit file size for downloads to prevent DoS
- Add rate limiting to prevent API abuse
- Ensure proper CORS configuration
- Validate file types before serving
- Implement authentication/authorization if needed
