# Bug: WebSocket workflow trigger validation error - invalid workflow_type generated by frontend

## Metadata
issue_number: `001`
adw_id: `ws001`
issue_json: `{"title": "WebSocket workflow trigger validation error", "body": "WebSocket connection established but workflow trigger fails with validation error for workflow_type field. Frontend generates invalid workflow names that don't match backend's valid ADWWorkflow literal types.", "number": "001"}`

## Bug Description
When triggering a workflow from the kanban board, the WebSocket connection is established successfully but the workflow trigger fails with a validation error: "Invalid request format: 1 validation error for WorkflowTriggerRequest workflow_type". The error occurs because the frontend's `getWorkflowTypeForStage()` function dynamically generates workflow names by joining stage names with underscores, creating workflow types that don't exist in the backend's `ADWWorkflow` literal type definition.

## Problem Statement
The frontend WebSocket service generates invalid workflow type names when mapping kanban stages to ADW workflow types. Specifically, the `getWorkflowTypeForStage()` function creates dynamic workflow names like `adw_plan_implement_iso` when a task has queued stages like `['plan', 'implement']`, but the backend only accepts predefined workflow names like `adw_plan_build_iso` (since 'implement' should map to 'build').

## Solution Statement
Fix the frontend stage mapping logic to ensure only valid workflow names that exist in the backend's `ADWWorkflow` literal type are generated. Update the stage-to-workflow mapping to properly handle queued stages and ensure all generated workflow names match the backend's validation requirements.

## Steps to Reproduce
1. Create a kanban task with queued stages containing 'implement' (e.g., `['plan', 'implement']`)
2. Ensure WebSocket connection is established (should show "WebSocket: Connected")
3. Click "Trigger Workflow" button on the kanban card
4. Observe the validation error in browser console and WebSocket server logs

## Root Cause Analysis
The issue occurs in `src/services/websocket/websocketService.js` in the `getWorkflowTypeForStage()` method:

1. When a task has `queuedStages`, the method maps kanban stages to ADW stage names using `stageMapping`
2. The mapping converts 'implement' to 'build', but then joins stages with underscores: `adw_${adwStages.join('_')}_iso`
3. This can create workflow names like `adw_plan_implement_iso` if the original queued stages contained 'implement'
4. The backend's `ADWWorkflow` literal type in `adws/adw_modules/data_types.py` doesn't include such dynamically generated names
5. Pydantic validation rejects the request before it reaches the workflow validation logic

## Relevant Files
Use these files to fix the bug:

- `src/services/websocket/websocketService.js` - Contains the `getWorkflowTypeForStage()` method that generates invalid workflow names
- `adws/adw_modules/data_types.py` - Contains the `ADWWorkflow` literal type with valid workflow names
- `adws/adw_modules/workflow_ops.py` - Contains the `AVAILABLE_ADW_WORKFLOWS` list for runtime validation
- `adws/adw_triggers/websocket_models.py` - Contains the `WorkflowTriggerRequest` model that validates workflow_type
- `adws/adw_triggers/trigger_websocket.py` - Contains the WebSocket server and validation logic
- `src/stores/kanbanStore.js` - Contains the workflow triggering logic that calls the WebSocket service

### New Files
- `.claude/commands/e2e/test_websocket_workflow_trigger.md` - E2E test to validate workflow triggering works correctly

## Step by Step Tasks
IMPORTANT: Execute every step in order, top to bottom.

### Update Frontend Stage-to-Workflow Mapping
- Read the backend's valid workflow types from `adws/adw_modules/data_types.py` to understand what workflow names are allowed
- Fix the `getWorkflowTypeForStage()` method in `src/services/websocket/websocketService.js` to only generate valid workflow names
- Ensure the stage mapping logic properly converts kanban stages to ADW stages before joining them
- Add validation to ensure generated workflow names exist in the backend's allowed list

### Add Frontend Validation
- Add a validation function in `websocketService.js` to check if a workflow name is valid before sending it to the backend
- Update error handling to provide better error messages when invalid workflow types are detected
- Add logging to help debug workflow name generation issues

### Create E2E Test for Workflow Triggering
- Read `.claude/commands/e2e/test_basic_query.md` and `.claude/commands/e2e/test_complex_query.md` and create a new E2E test file in `.claude/commands/e2e/test_websocket_workflow_trigger.md` that validates workflow triggering works correctly for various stage configurations, be specific with the steps to prove the bug is fixed and include screenshots to prove the workflow trigger succeeds

### Run Validation Commands
- Execute the validation commands to ensure the bug is fixed with zero regressions

## Validation Commands
Execute every command to validate the bug is fixed with zero regressions.

- `cd /Users/kvnkishore/WebstormProjects/AKApp/AgenticKanban && npm run dev` - Start the frontend development server
- `cd /Users/kvnkishore/WebstormProjects/AKApp/AgenticKanban && uv run scripts/start-websocket.sh` - Start the WebSocket server
- Test workflow triggering manually: Create a task with queued stages, verify WebSocket connection, trigger workflow and confirm it succeeds
- Read `.claude/commands/test_e2e.md`, then read and execute your new E2E `.claude/commands/e2e/test_websocket_workflow_trigger.md` test file to validate this functionality works
- `cd app/server && uv run pytest` - Run server tests to validate the bug is fixed with zero regressions
- `cd app/client && bun tsc --noEmit` - Run frontend tests to validate the bug is fixed with zero regressions
- `cd app/client && bun run build` - Run frontend build to validate the bug is fixed with zero regressions

## Notes
- The WebSocket connection itself is working correctly, only the workflow trigger validation is failing
- The backend validation is working as intended - the issue is on the frontend side
- Focus on fixing the stage mapping logic rather than changing backend validation
- Ensure backward compatibility with existing tasks and workflow configurations
- Test with various combinations of queued stages to ensure all generate valid workflow names